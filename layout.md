# layout

统一为小端写入。

## sst 格式

```text
    +----------------+
    | blocks         |
    +----------------+
    | blooms         |
    +----------------+
    | block offsets  | // u64
    +----------------+
    | filter offsets | // u64
    +----------------+
    | offs checksum  |
    +----------------+
    | meta           |
    +----------------+
```

其中，`Blocks` 的格式如下：

```text
    +---------------------+
    | entry 1             |
    +---------------------+
    | entry 2             |
    +---------------------+
    | ...                 |
    +---------------------+
    | entry n             |
    +---------------------+
    | entry 1 offset: u32 |
    +---------------------+
    | entry 2 offset: u32 |
    +---------------------+
    | ...                 |
    +---------------------+
    | entry n offset: u32 |
    +---------------------+
    | entry count: u32    |
    +---------------------+
    | check sum: u32      |
    +---------------------+
```

`Entry` 的格式如下：

```text
    +---------------------+
    | seq: u64            |
    +---------------------+
    | overlap len: u32    |
    +---------------------+
    | diff len: u32       |
    +---------------------+
    | value len: u32      |
    +---------------------+
    | value meta: u8      |
    +---------------------+
    | diff key            |
    +---------------------+
    | value or value ptr  |
    +---------------------+
```

`Meta` 格式如下

```text
    +-----------------------+
    | block start: u64      |
    +-----------------------+
    | filters start: u64    |
    +-----------------------+
    | all offset start: u64 |
    +-----------------------+
    | block count: u64      |
    +-----------------------+
    | max seq: u64          |
    +-----------------------+
    | compress type: u8     |
    +-----------------------+
    | check sum: u32        |
    +-----------------------+
    | magic number: u64     |
    +-----------------------+
```

如果 sst 太小，那么直接全部载入内存中。

## value log

`vlog` 文件格式如下

```text
    +---------+
    | entry 1 |
    +---------+
    | entry 2 |
    +---------+
    | ...     |
    +---------+
    | entry n |
    +---------+
```

`Entry` 格式如下

```text
    +----------------+
    | seq: u64       |
    +----------------+
    | key len: u32   |
    +----------------+
    | value len: u32 |
    +----------------+
    | key            |
    +----------------+
    | value          |
    +----------------+
    | check sum: u32 |
    +-----------------
```

需要支持并发随机读。

wal 复用 vlog 实现。

## manifest

一次快照生成的格式如下。

干脆用 json 之类的？然后直接一个 current 标记最新的 manifest ？

```text
    +------------------+
    | add wal file     |
    +------------------+
    | delete wal file  |
    +------------------+
    | add sst file     |
    +------------------+
    | delete sst file  |
    +------------------+
    | add vlog file    |
    +------------------+
    | delete vlog file |
    +------------------+
    | last wal id      |
    +------------------+
    | last sst id      |
    +------------------+
    | last vlog id     |
    +------------------+
    | seq number       |
    +------------------+
```